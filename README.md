# Мониторинг Интернета ЦСО-1

Утилита, висящая в фоне системы, выполняющая периодические пинги и трейсы проверки интернета в общежитии МТУСИ

[Панель мониторинга](https://monitor.slavapmk.ru)

# Оглавление

* [Установка](#установка)
  * [Windows](#windows)
  * [Ubuntu](#ubuntu)
* [Отключение](#отключение)
  * [Windows](#windows-1)
  * [Ubuntu](#ubuntu-1)
* [Механизм работы](#механизм-работы)
* [Конфигурация](#конфигурация)

# Установка

### Windows

Для подключения к мониторингу интернета выполните следующие действия

1. **Установите на компьютер Python**
    1. Скачайте [Windows Installer x64](https://www.python.org/ftp/python/3.12.10/python-3.12.10-amd64.exe)

        [Для других систем](https://www.python.org/downloads/release/python-31210/) (вероятно уже предустановлен)
    2. Прожмите `Add python.exe to PATH` и нажмите `Customize installation`
        <img src="https://i.imgur.com/jXJB3Dk.png">
    3. `Next`
        <img src="https://i.imgur.com/uwyztyH.png">
    4. `Install Python 3.12 for all users` -> `Install`
        <img src="https://i.imgur.com/EaQDLtz.png">
2. **Скачайте файл проекта**

    Code -> Download ZIP
    <img src="https://i.imgur.com/pGQRdmk.png">
3. **Распакуйте архив в директорию, не содержащую пробелы в имени.**
    
    Например, создайте папку `C:\Monitoring` и распакуйте файлы в директорию
    <img src="https://i.imgur.com/pVrtDGL.png">
4. **Запустите файл `install.bat`**

    Это установит все необходимые библиотеки для работы
    <img src="https://i.imgur.com/bS20hz0.png">
5. **Сделайте начальную настройку**
   1. Сделайте тестовый запуск

       Запустите файл `run.bat`, через несколько секунд закройте окно
       <img src="https://i.imgur.com/UvPAYoX.png">

       Появится файл `config.yaml`, настройте его
       <img src="https://i.imgur.com/UvPAYoX.png">
   2. Установите переменную `room` на свою (только численное значение)
       <img src="https://i.imgur.com/8Il2IHR.png">

       При желании можете более подробно установить [свои настройки](#%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8F)
6. **Запустите `add_to_startup.bat`, это добавит мониторинг в автозапуск системы**
    <img src="https://i.imgur.com/SaMXbV3.png">

### Ubuntu

### Установка

# Отключение

### Windows

1. Остановите запущенный процесс в диспечере задач
    <img src="https://i.imgur.com/3B6YYi9.png">
2. Для отключения автозапуска **либо** отключите его в диспечере задач
    <img src="https://i.imgur.com/eJBuMBi.png">
    **Либо** запустите файл `remove_from_startup.bat`
    <img src="https://i.imgur.com/806tJV1.png">
3. После этого можете удалить папку
    <img src="https://i.imgur.com/1JoI60H.png">

### Ubuntu

# Механизм работы
При включении компьютера, запускается фоновый процесс `pythonw.exe` (/ systemd python), который запускает 2 асинхронные функции
1. `async main` - основной цикл. 
   1. Механизм проверки интернета
      1. Он бесконечно запускает системный процесс `ping`, по стандарту **1 пакет** раз в **10 секунд**
      2. Если проверка интернета не прошла, запускается `trace`. Который проверяет не полное соединение от А до Б, а делает проверку каждого узла, скозь который должен пройти трафик. Обычно проверка занимает до 10-60 секунд. Эти данные фигурируют только для будующей ручной диагностики, они нигде не фигурируют
      3. Сразу после `trace` запускается контрольный тест, для уточнения отсутсвия интернета. Отправляется 10 пакетов, и если один из них не прошёл, то программа переходит в режим ожидания сети
      4. Во время ожидания сети отправляются по 1 пакету каждую 1 секунду, до того момента, как сеть не восстоновливается. Если соединение восстановилось, программа переходит в обычный режим
      5. Раз в 5 минут запускается длительная проверка `trace` для проверки состояния

      Проврка `trace` делается для того, чтобы узнать, не работает или доступ во внешнюю сеть, или умер внутренний кросс на этаже / центральный общежития
   2. Все данные собираются в 3 файла
      1. `ping_DATE_TIME.jsonl` содержит структурированные логи с информацией о пинге (каждая строчка - отдельная JSON запись):
         1. `stamp` - время проверки
         2. `raw` - "сырой" вывод из консоли
         3. `times_ms` - время подключения до каждого узла
         4. `avg_ms` - среднее время проверки
         5. `network_info` - информация о текущем подключении к интернету

      ```yaml
         {
            "stamp": "2025-11-24T23:28:36.025089",
            "raw": "\n\u041e\u0431\u043c\u0435 ...",
            "times_ms": [
               41.0,
               97.0,
               ...
            ],
            "avg_ms": 76.3,
            "network_info": {...}
         }
         ...
         ```
      2. `trace_DATE_TIME.jsonl` - Информация о трейсах (каждая строчка - отдельная JSON запись)
         1. `stamp` - время проверки
         2. `raw` - "сырой" вывод из консоли
         3. `hops` - информация подключения до каждого узла
            1. `hop` - порядковый номер "хопа"
            2. `ip` - адрес промежуточного узла 
            3. `host` - текстовое название узла
         4. `network_info` - информация о текущем подключении к интернету
   
         ```yaml
         {
            "stamp": "2025-11-24T23:29:42.898314",
            "raw": "\n\u0422\u0440\u0430\u0441 ...",
            "hops": [
               {
                  "hop": 1,
                  "ip": "10.8.1.0",
                  "host": "10.8.1.0"
               },
               ...
            ],
            "network_info": {...}
         }
         ...
         ```
      4. `losses_DATE_TIME.jsonl` - Подведённая статистика о потерях в виде словаря за всё время. Всё в виде единого JSON объекта
         1. `Ключ` - timestamp проверки
         2. `packets` - суммарное отправленное количество пакетов за минуту
         3. `reached` - суммарное количество доставленных пакетов
         В течение минуты собирается статистика по пакетам, далее - если потерь нет (т.е. кол-во отправленных = кол-ву дотавленных), то строчка автоматически удаляется.
      
         ```yaml
         {
            "2025-11-24 23:27": {
              "packets": 30,    # Всего было отправлено 30 пакетов
              "reached": 29     # Из них дошло только 29
            },                  # => потеря за минуту 1/30 = 3.33%
            ...                 # В файле игнорируются минуты с 0% потерями
         }
         ```
   3. Названия файлов содержат одинаковую DATE_TIME времени запуска. Каждые 1000 секунд и во время запуска запускается механизм ротации:
      1. Если в папке `data` уже содержатся какие-то файлы, то они группируются по DATE_TIME и создаётся архив `archive_DATE_TIME.zip`
      2. Архив перемещается в директорию `sending` и так со всеми имеющимися файлами

2. `async sender` - асинхронная функция отправки на сервер
   1. Раз в минуту проверяется директория `sending` на наличие готовых архивов к отправке
   2. При наличии файлов они последовательно отпрвляются `POST` -> `https://{endpoint}/upload/{room}/`
   3. В случае успеха, файлы удаляются. Если нет, то попытка игнорируется

# Конфигурация

Стандартный конфиг выглядит следующим образом
```yaml
room: null
endpoint: https://monitor.slavapmk.ru
ping:
  standart:
    packet_count: 1
    delay: 10
  check:
    packet_count: 10
  continious:
    packet_count: 1
    delay: 1
timing:
  timeouts:
    connect_secs: 10
    upload_secs: 300
  trace_check_secs: 300
  rotation_secs: 1000
  sender_check_secs: 60
```

1. Число int32 `room` указывает номер комнаты, отображаемый на графике, принимаются значения **от 100 до 555**
2. Строчка `endpoint` ведёт на корень сервера отгрузки данных. Фактически отгрузка ведётся на `{endpoint}/upload/{room}/`

   Пример: https://monitor.slavapmk.ru/upload/111/
3. Блок `ping` отвечает за настройку параметров проведения ping-запросов
   1. Блок `standart` отвечает за стандартные проверки
      2. Число int32 `delay` отвечает за время между проверками
      1. Число int32 `packet_count` отвечает за количество пакетов во время короткой проверки

      По стандарту: **1 пакет** раз в **10 секунд**
   2. Блок `check` отвечает за контролную проверку, если стандартная не прошла
      1. Число int32 `packet_count` отвечает за количество пакетов, отправленных во время одиночной проверки, если стандартный короткий пинг не прошёл

      Если эта проверка не сработает, то программа переходит в режим ожидания возобновленя сети - проверки должны проходить чаще

      По стандарту: **2 пакета**
   3. Блок `continious` отвечает за ожидающую проверку, которая работает до возобновления работы интернета
      2. Число int32 `delay` отвечает за время между проверками
      1. Число int32 `packet_count` отвечает за количество пакетов во время ожидания сети

      По стандарту: **1 пакет** раз в **1 секунду**
4. Блок `timing` отвечает за настройку остальных параметров времени
   1. Блок `timeouts` отвечает за максимальное время ожидания
      1. Число int32 `connect_secs` отвечает за время подключения к серверу
      
      По стандарту: **10 секунд**
      2. Число int32 `upload_secs` отвечает за время отгрузки одного файла
      
      По стандарту: **300 секунд** (5 минут)
   2. Число int32 `trace_check_secs` отвечает за регулярную проверку полную trace маршрута до адреса проверки
      
      По стандарту: **300 секунд** (5 минут)
   3. Число int32 `rotation_secs` отвечает за время между сбором данных в архив и отправки в очередь на отправку
      
      По стандарту: **1000 секунд** (примерно 17 минут)
   4. Число int32 `sender_check_secs` отвечает за время между регулярными проверками на наличие файлов на отправку
      
      По стандарту: раз в **60 секунд** (1 минута)
